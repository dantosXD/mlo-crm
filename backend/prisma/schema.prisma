// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          String    @default("MLO") // ADMIN, MANAGER, MLO, PROCESSOR, UNDERWRITER, VIEWER
  isActive      Boolean   @default(true) @map("is_active")
  preferences   String?   @default("{}") // JSON string for user preferences (dashboard layout, etc.)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  clients       Client[]
  notes         Note[]
  tasks         Task[]
  activities    Activity[]
  notifications Notification[]
  communications Communication[]
  workflows     Workflow[]
  workflowVersions WorkflowVersion[]

  @@map("users")
}

// Clients table (with encrypted PII)
model Client {
  id              String    @id @default(uuid())
  nameEncrypted   String    @map("name_encrypted") // JSON string
  emailEncrypted  String    @map("email_encrypted") // JSON string
  phoneEncrypted  String    @map("phone_encrypted") // JSON string
  nameHash        String    @map("name_hash")
  emailHash       String    @map("email_hash")
  phoneHash       String    @map("phone_hash")
  status          String    @default("LEAD") // LEAD, PRE_QUALIFIED, ACTIVE, PROCESSING, UNDERWRITING, CLEAR_TO_CLOSE, CLOSED, DENIED, INACTIVE
  tags            String    @default("[]") // JSON array string
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  createdById     String    @map("created_by_id")
  createdBy       User      @relation(fields: [createdById], references: [id])
  notes           Note[]
  tasks           Task[]
  documents       Document[]
  loanScenarios   LoanScenario[]
  activities      Activity[]
  financialProfile ClientFinancialProfile?
  communications  Communication[]
  workflowExecutions WorkflowExecution[]

  @@index([nameHash])
  @@index([emailHash])
  @@index([phoneHash])
  @@index([status])
  @@index([createdAt])
  @@map("clients")
}

// Client financial profile
model ClientFinancialProfile {
  id              String    @id @default(uuid())
  clientId        String    @unique @map("client_id")
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  annualIncome    Float?    @map("annual_income")
  monthlyDebts    Float?    @map("monthly_debts")
  creditScore     Int?      @map("credit_score")
  employmentType  String?   @map("employment_type")
  employerName    String?   @map("employer_name")
  yearsEmployed   Float?    @map("years_employed")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("client_financial_profiles")
}

// Notes table
model Note {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  text        String
  tags        String    @default("[]") // JSON array string
  isPinned    Boolean   @default(false) @map("is_pinned")
  createdById String    @map("created_by_id")
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([createdAt])
  @@map("notes")
}

// Tasks table
model Task {
  id          String    @id @default(uuid())
  clientId    String?   @map("client_id")
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  text        String
  description String?
  status      String    @default("TODO") // TODO, IN_PROGRESS, COMPLETE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  assignedToId String?  @map("assigned_to_id")
  assignedTo  User?     @relation(fields: [assignedToId], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  subtasks    TaskSubtask[]

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

// Task subtasks
model TaskSubtask {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  text        String
  isCompleted Boolean   @default(false) @map("is_completed")
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("task_subtasks")
}

// Documents table
model Document {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  fileName    String    @map("file_name")
  filePath    String    @map("file_path")
  fileSize    Int       @map("file_size")
  mimeType    String    @map("mime_type")
  status      String    @default("UPLOADED") // REQUIRED, REQUESTED, UPLOADED, UNDER_REVIEW, APPROVED, REJECTED, EXPIRED
  category    String    @default("OTHER") // INCOME, EMPLOYMENT, ASSETS, PROPERTY, INSURANCE, CREDIT, OTHER
  dueDate     DateTime? @map("due_date")
  expiresAt   DateTime? @map("expires_at")
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([status])
  @@index([category])
  @@map("documents")
}

// Loan scenarios table
model LoanScenario {
  id                  String    @id @default(uuid())
  clientId            String    @map("client_id")
  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name                String
  loanType            String    @map("loan_type") // PURCHASE, REFINANCE
  amount              Float
  interestRate        Float     @map("interest_rate")
  termYears           Int       @map("term_years")
  downPayment         Float?    @map("down_payment")
  propertyValue       Float?    @map("property_value")
  propertyTaxes       Float?    @map("property_taxes")
  homeInsurance       Float?    @map("home_insurance")
  hoaFees             Float?    @map("hoa_fees")
  pmiRate             Float?    @map("pmi_rate")
  monthlyPayment      Float?    @map("monthly_payment")
  totalMonthlyPayment Float?    @map("total_monthly_payment")
  totalInterest       Float?    @map("total_interest")
  loanToValue         Float?    @map("loan_to_value")
  debtToIncome        Float?    @map("debt_to_income")
  isPreferred         Boolean   @default(false) @map("is_preferred")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@map("loan_scenarios")
}

// Activity log for audit trail
model Activity {
  id          String    @id @default(uuid())
  clientId    String?   @map("client_id")
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  type        String    // CLIENT_CREATED, CLIENT_UPDATED, STATUS_CHANGED, NOTE_ADDED, etc.
  description String
  metadata    String?   // JSON string
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([clientId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

// Document packages (templates)
model DocumentPackage {
  id          String    @id @default(uuid())
  name        String
  description String?
  isStandard  Boolean   @default(false) @map("is_standard")
  documents   String    // JSON array of document types
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("document_packages")
}

// Note templates
model NoteTemplate {
  id          String    @id @default(uuid())
  name        String
  content     String
  tags        String    @default("[]") // JSON array string
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("note_templates")
}

// Task templates
model TaskTemplate {
  id          String    @id @default(uuid())
  name        String
  description String?
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  dueDays     Int?      @map("due_days")
  steps       String?   // JSON array of subtask steps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("task_templates")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Notifications for users
model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String    // DOCUMENT_DUE, TASK_DUE, DOCUMENT_REMINDER, etc.
  title       String
  message     String
  link        String?   // Optional link to related resource
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  metadata    String?   // JSON string for additional data
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Communication templates (email/SMS/letter templates)
model CommunicationTemplate {
  id            String    @id @default(uuid())
  name          String
  type          String    // EMAIL, SMS, LETTER
  category      String?   // WELCOME, FOLLOWUP, REMINDER, STATUS_UPDATE, etc.
  subject       String?   // For EMAIL and LETTER only
  body          String
  placeholders  String?   // JSON array of available placeholders (e.g., ["client_name", "due_date"])
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  communications Communication[]

  @@index([type])
  @@index([category])
  @@index([isActive])
  @@map("communication_templates")
}

// Communications (emails, SMS, letters sent to clients)
model Communication {
  id            String    @id @default(uuid())
  clientId      String    @map("client_id")
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type          String    // EMAIL, SMS, LETTER
  status        String    @default("DRAFT") // DRAFT, READY, SENT, FAILED
  subject       String?   // For EMAIL and LETTER only
  body          String
  templateId    String?   @map("template_id")
  template      CommunicationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  scheduledAt   DateTime? @map("scheduled_at")
  sentAt        DateTime? @map("sent_at")
  followUpDate  DateTime? @map("follow_up_date")  // Date for follow-up reminder
  attachments   String?   // JSON array of file references (file_name, file_path, file_size, mime_type)
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  metadata      String?   // JSON string for additional data (e.g., email provider response)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([type])
  @@index([status])
  @@index([scheduledAt])
  @@index([followUpDate])
  @@index([createdAt])
  @@map("communications")
}

// Workflows for automation
model Workflow {
  id            String    @id @default(uuid())
  name          String
  description   String?
  isActive      Boolean   @default(true) @map("is_active")
  isTemplate    Boolean   @default(false) @map("is_template")
  triggerType   String    @map("trigger_type") // CLIENT_CREATED, CLIENT_STATUS_CHANGED, DOCUMENT_UPLOADED, etc.
  triggerConfig String?   @map("trigger_config") // JSON string for trigger configuration
  conditions    String?   // JSON string for workflow conditions
  actions       String    // JSON array of actions to execute
  version       Int       @default(1)
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  executions    WorkflowExecution[]
  versions      WorkflowVersion[]

  @@index([triggerType])
  @@index([isActive])
  @@index([createdAt])
  @@map("workflows")
}

// Workflow versions (historical versions for rollback)
model WorkflowVersion {
  id            String    @id @default(uuid())
  workflowId    String    @map("workflow_id")
  workflow      Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  version       Int
  name          String
  description   String?
  triggerType   String    @map("trigger_type")
  triggerConfig String?   @map("trigger_config")
  conditions    String?
  actions       String
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([workflowId])
  @@index([version])
  @@map("workflow_versions")
}

// Workflow executions (runtime instances)
model WorkflowExecution {
  id            String    @id @default(uuid())
  workflowId    String    @map("workflow_id")
  workflow      Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  clientId      String?   @map("client_id")
  client        Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  status        String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED, PAUSED
  triggerData   String?   @map("trigger_data") // JSON string with data that triggered the workflow
  currentStep   Int       @default(0) @map("current_step")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  errorMessage  String?   @map("error_message")
  logs          String?   // JSON array of log entries
  retryCount    Int       @default(0) @map("retry_count") // Number of retry attempts
  maxRetries    Int       @default(3) @map("max_retries") // Maximum retry attempts allowed
  lastRetryAt   DateTime? @map("last_retry_at") // Timestamp of last retry attempt
  nextRetryAt   DateTime? @map("next_retry_at") // Scheduled time for next retry
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  executionLogs WorkflowExecutionLog[]

  @@index([workflowId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("workflow_executions")
}

// Workflow execution logs (detailed step tracking)
model WorkflowExecutionLog {
  id            String            @id @default(uuid())
  executionId   String            @map("execution_id")
  execution     WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stepIndex     Int               @map("step_index")
  actionType    String            @map("action_type") // SEND_EMAIL, CREATE_TASK, UPDATE_CLIENT, etc.
  status        String            // SUCCESS, FAILED, SKIPPED
  inputData     String?           @map("input_data") // JSON string
  outputData    String?           @map("output_data") // JSON string
  errorMessage  String?           @map("error_message")
  executedAt    DateTime          @default(now()) @map("executed_at")

  @@index([executionId])
  @@index([executedAt])
  @@map("workflow_execution_logs")
}
