// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          String    @default("MLO") // ADMIN, MANAGER, MLO, PROCESSOR, UNDERWRITER, VIEWER
  isActive      Boolean   @default(true) @map("is_active")
  deletedAt     DateTime? @map("deleted_at")
  preferences   String?   @default("{}") // JSON string for user preferences (dashboard layout, etc.)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  clients       Client[]
  notes         Note[]
  activities    Activity[]
  notifications Notification[]
  communications Communication[]
  workflows     Workflow[]
  workflowVersions WorkflowVersion[]
  createdEvents Event[] @relation("EventCreator")
  assignedTasks Task[] @relation("TaskAssignee")
  createdTasks Task[] @relation("TaskCreator")
  createdTaskTemplates TaskTemplate[] @relation("TaskTemplateCreator")

  // Loan program templates
  loanProgramTemplates LoanProgramTemplate[] @relation("LoanProgramTemplateCreator")

  // Calendar sharing relations
  ownedCalendarShares CalendarShare[] @relation("CalendarOwner")
  sharedWithMe CalendarShare[] @relation("SharedWithUser")

  // Reminder relations
  reminders Reminder[] @relation("ReminderUser")

  @@index([deletedAt])
  @@map("users")
}

// Clients table (with encrypted PII)
model Client {
  id              String    @id @default(uuid())
  nameEncrypted   String    @map("name_encrypted") // JSON string
  emailEncrypted  String    @map("email_encrypted") // JSON string
  phoneEncrypted  String    @map("phone_encrypted") // JSON string
  nameHash        String    @map("name_hash")
  emailHash       String    @map("email_hash")
  phoneHash       String    @map("phone_hash")
  status          String    @default("LEAD") // LEAD, PRE_QUALIFIED, ACTIVE, PROCESSING, UNDERWRITING, CLEAR_TO_CLOSE, CLOSED, DENIED, INACTIVE
  deletedAt       DateTime? @map("deleted_at")
  tags            String    @default("[]") // JSON array string
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  createdById     String    @map("created_by_id")
  createdBy       User      @relation(fields: [createdById], references: [id])
  notes           Note[]
  tasks           Task[]
  documents       Document[]
  loanScenarios   LoanScenario[]
  activities      Activity[]
  financialProfile ClientFinancialProfile?
  communications  Communication[]
  workflowExecutions WorkflowExecution[]
  events          Event[]
  reminders       Reminder[]

  @@index([nameHash])
  @@index([emailHash])
  @@index([phoneHash])
  @@index([status])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("clients")
}

// Client financial profile
model ClientFinancialProfile {
  id              String    @id @default(uuid())
  clientId        String    @unique @map("client_id")
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  annualIncome    Float?    @map("annual_income")
  monthlyDebts    Float?    @map("monthly_debts")
  creditScore     Int?      @map("credit_score")
  employmentType  String?   @map("employment_type")
  employerName    String?   @map("employer_name")
  yearsEmployed   Float?    @map("years_employed")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("client_financial_profiles")
}

// Notes table
model Note {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  text        String
  tags        String    @default("[]") // JSON array string
  isPinned    Boolean   @default(false) @map("is_pinned")
  deletedAt   DateTime? @map("deleted_at")
  createdById String    @map("created_by_id")
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("notes")
}

// Tasks table
model Task {
  id          String    @id @default(uuid())
  clientId    String?   @map("client_id")
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  text        String
  description String?
  status      String    @default("TODO") // TODO, IN_PROGRESS, COMPLETE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  type        String    @default("GENERAL") // GENERAL, CLIENT_SPECIFIC, WORKFLOW_RELATED, FOLLOW_UP, COMPLIANCE
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  assignedToId String?  @map("assigned_to_id")
  assignedTo  User?     @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdById String?   @map("created_by_id")
  createdBy   User?     @relation("TaskCreator", fields: [createdById], references: [id])
  tags        String    @default("[]") // JSON array string
  deletedAt   DateTime? @map("deleted_at") // Soft delete support
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Reminder settings
  reminderEnabled Boolean   @default(false) @map("reminder_enabled")
  reminderTimes   String?   @default("[]") @map("reminder_times") // JSON array: ["AT_TIME", "15MIN", "1HR", "1DAY", "1WEEK"]
  reminderMessage String?   @map("reminder_message") // Custom reminder message
  snoozedUntil    DateTime? @map("snoozed_until") // Snooze deadline

  // Recurring task settings
  isRecurring           Boolean   @default(false) @map("is_recurring")
  recurringPattern      String?   @map("recurring_pattern") // DAILY, WEEKLY, MONTHLY, CUSTOM
  recurringInterval     Int?      @map("recurring_interval") // e.g., every 2 weeks
  recurringEndDate       DateTime? @map("recurring_end_date") // Optional end date for recurrence
  recurringTaskId       String?   @map("recurring_task_id") // Parent recurring task ID

  // Relations
  subtasks         TaskSubtask[]
  reminderHistory  TaskReminderHistory[]
  attachments      TaskAttachment[]
  parentRecurring  Task?       @relation("RecurringTasks", fields: [recurringTaskId], references: [id], onDelete: SetNull)
  recurringTasks   Task[]      @relation("RecurringTasks")

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedToId])
  @@index([deletedAt])
  @@index([type])
  @@map("tasks")
}

// Task subtasks
model TaskSubtask {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  text        String
  isCompleted Boolean   @default(false) @map("is_completed")
  order       Int       @default(0)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([deletedAt])
  @@map("task_subtasks")
}

// Task reminder history
model TaskReminderHistory {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String    @map("user_id")
  remindedAt  DateTime  @default(now()) @map("reminded_at")
  reminderType String   @map("reminder_type") // AT_TIME, 15MIN, 1HR, 1DAY, 1WEEK, OVERDUE_ESCALATION
  method      String    // IN_APP, EMAIL, PUSH
  delivered   Boolean   @default(true) // Whether delivery was successful
  metadata    String?   // JSON string for additional data

  @@index([taskId])
  @@index([userId])
  @@index([remindedAt])
  @@map("task_reminder_history")
}

// Task attachments (documents, links, notes)
model TaskAttachment {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  type        String    // DOCUMENT, LINK, NOTE
  name        String
  url         String?   // For links and documents
  filePath    String?   @map("file_path") // For documents
  content     String?   // For notes
  metadata    String?   // JSON string for additional data
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by_id")

  @@index([taskId])
  @@index([type])
  @@index([deletedAt])
  @@map("task_attachments")
}

// Documents table
model Document {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name        String
  fileName    String    @map("file_name")
  filePath    String    @map("file_path")
  fileSize    Int       @map("file_size")
  mimeType    String    @map("mime_type")
  status      String    @default("UPLOADED") // REQUIRED, REQUESTED, UPLOADED, UNDER_REVIEW, APPROVED, REJECTED, EXPIRED
  category    String    @default("OTHER") // INCOME, EMPLOYMENT, ASSETS, PROPERTY, INSURANCE, CREDIT, OTHER
  dueDate     DateTime? @map("due_date")
  expiresAt   DateTime? @map("expires_at")
  notes       String?
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([status])
  @@index([category])
  @@index([deletedAt])
  @@map("documents")
}

// Loan scenarios table — supports rich multi-program comparisons
model LoanScenario {
  id                  String    @id @default(uuid())
  clientId            String    @map("client_id")
  client              Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name                String
  loanType            String    @map("loan_type") // PURCHASE, REFINANCE
  amount              Float
  interestRate        Float     @map("interest_rate")
  termYears           Int       @map("term_years")
  downPayment         Float?    @map("down_payment")
  propertyValue       Float?    @map("property_value")
  propertyTaxes       Float?    @map("property_taxes")
  homeInsurance       Float?    @map("home_insurance")
  hoaFees             Float?    @map("hoa_fees")
  pmiRate             Float?    @map("pmi_rate")
  monthlyPayment      Float?    @map("monthly_payment")
  totalMonthlyPayment Float?    @map("total_monthly_payment")
  totalInterest       Float?    @map("total_interest")
  loanToValue         Float?    @map("loan_to_value")
  debtToIncome        Float?    @map("debt_to_income")
  isPreferred         Boolean   @default(false) @map("is_preferred")

  // Rich comparison data — JSON blob storing LoanScenarioData (inputs + programs array)
  scenarioData        String?   @map("scenario_data") // JSON: { inputs, programs, debts, programDebtSelections }
  preferredProgramId  String?   @map("preferred_program_id") // ID of the recommended program within scenarioData
  status              String    @default("DRAFT") // DRAFT, PROPOSED, SHARED, ARCHIVED
  deletedAt           DateTime? @map("deleted_at")
  version             String    @default("1.0.0")
  recommendationNotes String?   @map("recommendation_notes") // MLO notes on why the preferred program is recommended
  sharedAt            DateTime? @map("shared_at") // When shared with client
  createdById         String?   @map("created_by_id")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([status])
  @@index([deletedAt])
  @@index([createdById])
  @@map("loan_scenarios")
}

// Configurable loan program templates per user/org
model LoanProgramTemplate {
  id              String    @id @default(uuid())
  name            String    // e.g. "Conventional 30yr Fixed", "5/1 ARM 30yr"
  category        String    @default("FIXED") // FIXED, ARM
  termYears       Int       @map("term_years") // 15, 20, 30
  defaultRate     Float?    @map("default_rate") // Optional default interest rate

  // ARM-specific configuration (JSON)
  // { initialPeriod: 5, adjustmentPeriod: 1, initialCap: 2, periodicCap: 2, lifetimeCap: 5, indexName: "SOFR", margin: 2.75 }
  armConfig       String?   @map("arm_config")

  // Loan type constraints
  loanType        String    @default("conventional") @map("loan_type") // conventional, fha, va, usda, jumbo, portfolio

  isActive        Boolean   @default(true) @map("is_active")
  deletedAt       DateTime? @map("deleted_at")
  sortOrder       Int       @default(0) @map("sort_order")
  notes           String?   // Internal notes about this program

  createdById     String    @map("created_by_id")
  createdBy       User      @relation("LoanProgramTemplateCreator", fields: [createdById], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([createdById])
  @@index([isActive])
  @@index([deletedAt])
  @@index([category])
  @@index([sortOrder])
  @@map("loan_program_templates")
}

// Activity log for audit trail
model Activity {
  id          String    @id @default(uuid())
  clientId    String?   @map("client_id")
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id])
  type        String    // CLIENT_CREATED, CLIENT_UPDATED, STATUS_CHANGED, NOTE_ADDED, etc.
  description String
  metadata    String?   // JSON string
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([clientId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

// Document packages (templates)
model DocumentPackage {
  id          String    @id @default(uuid())
  name        String
  description String?
  isStandard  Boolean   @default(false) @map("is_standard")
  documents   String    // JSON array of document types
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("document_packages")
}

// Note templates
model NoteTemplate {
  id          String    @id @default(uuid())
  name        String
  content     String
  tags        String    @default("[]") // JSON array string
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("note_templates")
}

// Task templates
model TaskTemplate {
  id          String    @id @default(uuid())
  name        String
  description String?
  text        String    // Default task text/title
  type        String    @default("GENERAL") // GENERAL, CLIENT_SPECIFIC, WORKFLOW_RELATED, FOLLOW_UP, COMPLIANCE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  tags        String    @default("[]") // JSON array string
  dueDays     Int?      @map("due_days")
  steps       String?   // JSON array of subtask steps
  deletedAt   DateTime? @map("deleted_at")
  createdById String?   @map("created_by_id")
  createdBy   User?     @relation("TaskTemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([type])
  @@index([deletedAt])
  @@index([createdById])
  @@map("task_templates")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Notifications for users
model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String    // DOCUMENT_DUE, TASK_DUE, DOCUMENT_REMINDER, etc.
  title       String
  message     String
  link        String?   // Optional link to related resource
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  metadata    String?   // JSON string for additional data
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("notifications")
}

// Communication templates (email/SMS/letter templates)
model CommunicationTemplate {
  id            String    @id @default(uuid())
  name          String
  type          String    // EMAIL, SMS, LETTER
  category      String?   // WELCOME, FOLLOWUP, REMINDER, STATUS_UPDATE, etc.
  subject       String?   // For EMAIL and LETTER only
  body          String
  placeholders  String?   // JSON array of available placeholders (e.g., ["client_name", "due_date"])
  isActive      Boolean   @default(true) @map("is_active")
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  communications Communication[]

  @@index([type])
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
  @@map("communication_templates")
}

// Communications (emails, SMS, letters sent to clients)
model Communication {
  id            String    @id @default(uuid())
  clientId      String    @map("client_id")
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type          String    // EMAIL, SMS, LETTER
  status        String    @default("DRAFT") // DRAFT, READY, SENT, FAILED
  subject       String?   // For EMAIL and LETTER only
  body          String
  templateId    String?   @map("template_id")
  template      CommunicationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  scheduledAt   DateTime? @map("scheduled_at")
  sentAt        DateTime? @map("sent_at")
  followUpDate  DateTime? @map("follow_up_date")  // Date for follow-up reminder
  attachments   String?   // JSON array of file references (file_name, file_path, file_size, mime_type)
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  metadata      String?   // JSON string for additional data (e.g., email provider response)
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@index([type])
  @@index([status])
  @@index([scheduledAt])
  @@index([followUpDate])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("communications")
}

// Workflows for automation
model Workflow {
  id            String    @id @default(uuid())
  name          String
  description   String?
  isActive      Boolean   @default(true) @map("is_active")
  isTemplate    Boolean   @default(false) @map("is_template")
  deletedAt     DateTime? @map("deleted_at")
  triggerType   String    @map("trigger_type") // CLIENT_CREATED, CLIENT_STATUS_CHANGED, DOCUMENT_UPLOADED, etc.
  triggerConfig String?   @map("trigger_config") // JSON string for trigger configuration
  conditions    String?   // JSON string for workflow conditions
  actions       String    // JSON array of actions to execute
  version       Int       @default(1)
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  executions    WorkflowExecution[]
  versions      WorkflowVersion[]

  @@index([triggerType])
  @@index([isActive])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("workflows")
}

// Workflow versions (historical versions for rollback)
model WorkflowVersion {
  id            String    @id @default(uuid())
  workflowId    String    @map("workflow_id")
  workflow      Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  version       Int
  name          String
  description   String?
  triggerType   String    @map("trigger_type")
  triggerConfig String?   @map("trigger_config")
  conditions    String?
  actions       String
  createdById   String    @map("created_by_id")
  createdBy     User      @relation(fields: [createdById], references: [id])
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([workflowId])
  @@index([version])
  @@map("workflow_versions")
}

// Workflow executions (runtime instances)
model WorkflowExecution {
  id            String    @id @default(uuid())
  workflowId    String    @map("workflow_id")
  workflow      Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  clientId      String?   @map("client_id")
  client        Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  status        String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED, PAUSED
  triggerData   String?   @map("trigger_data") // JSON string with data that triggered the workflow
  currentStep   Int       @default(0) @map("current_step")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  errorMessage  String?   @map("error_message")
  logs          String?   // JSON array of log entries
  retryCount    Int       @default(0) @map("retry_count") // Number of retry attempts
  maxRetries    Int       @default(3) @map("max_retries") // Maximum retry attempts allowed
  lastRetryAt   DateTime? @map("last_retry_at") // Timestamp of last retry attempt
  nextRetryAt   DateTime? @map("next_retry_at") // Scheduled time for next retry
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  executionLogs WorkflowExecutionLog[]

  @@index([workflowId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("workflow_executions")
}

// Workflow execution logs (detailed step tracking)
model WorkflowExecutionLog {
  id            String            @id @default(uuid())
  executionId   String            @map("execution_id")
  execution     WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stepIndex     Int               @map("step_index")
  actionType    String            @map("action_type") // SEND_EMAIL, CREATE_TASK, UPDATE_CLIENT, etc.
  status        String            // SUCCESS, FAILED, SKIPPED
  inputData     String?           @map("input_data") // JSON string
  outputData    String?           @map("output_data") // JSON string
  errorMessage  String?           @map("error_message")
  executedAt    DateTime          @default(now()) @map("executed_at")

  @@index([executionId])
  @@index([executedAt])
  @@map("workflow_execution_logs")
}

// Events for calendar
model Event {
  id              String    @id @default(uuid())
  title           String
  description     String?
  eventType       String    @map("event_type") // MEETING, APPOINTMENT, CLOSING, FOLLOW_UP, CUSTOM, TASK, REMINDER
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  allDay          Boolean   @default(false) @map("all_day")
  location        String?
  clientId        String?   @map("client_id")
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  taskId          String?   @map("task_id")
  createdById     String    @map("created_by_id")
  createdBy       User      @relation("EventCreator", fields: [createdById], references: [id])

  // Recurrence settings
  isRecurring     Boolean   @default(false) @map("is_recurring")
  recurringRule   String?   @map("recurring_rule") // RRULE format or custom pattern: DAILY, WEEKLY, MONTHLY, YEARLY, CUSTOM
  recurringEndDate DateTime? @map("recurring_end_date") // Optional end date for recurrence
  recurringEventId String?  @map("recurring_event_id") // Parent recurring event ID
  parentRecurring Event?    @relation("RecurringEvents", fields: [recurringEventId], references: [id], onDelete: SetNull)
  recurringEvents Event[]   @relation("RecurringEvents")

  // Attendees
  eventAttendees  EventAttendee[]

  // Reminders
  reminders       String    @default("[]") // JSON array of reminder minutes before event [15, 60, 1440]

  // Status
  status          String    @default("CONFIRMED") // CONFIRMED, TENTATIVE, CANCELLED, COMPLETED
  color           String?   // Hex color code for display

  // External sync
  externalId      String?   @map("external_id") // ID from external calendar (Google, Outlook, etc.)
  externalCalendar String? @map("external_calendar") // Source calendar name
  lastSyncedAt    DateTime? @map("last_synced_at")

  // Metadata
  metadata        String?   // JSON string for additional data
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([startTime])
  @@index([endTime])
  @@index([eventType])
  @@index([clientId])
  @@index([taskId])
  @@index([createdById])
  @@index([status])
  @@index([deletedAt])
  @@map("events")
}

// Event attendees for tracking RSVPs
model EventAttendee {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      String?  @map("user_id")
  email       String
  name        String?
  rsvpStatus  String   @default("NEEDS_ACTION") @map("rsvp_status") // NEEDS_ACTION, ACCEPTED, DECLINED, TENTATIVE
  respondedAt DateTime? @map("responded_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([eventId])
  @@index([email])
  @@map("event_attendees")
}

// Reminders for time-sensitive notifications separate from tasks
model Reminder {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation("ReminderUser", fields: [userId], references: [id], onDelete: Cascade)

  // Optional client association
  clientId    String?   @map("client_id")
  client      Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Reminder details
  title       String
  description String?
  category    String    @default("GENERAL") // GENERAL, CLIENT, COMPLIANCE, CLOSING, FOLLOW_UP
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT

  // Timing
  remindAt    DateTime  @map("remind_at") // When to show the reminder
  dueDate     DateTime? @map("due_date") // Optional due date for the reminder

  // Recurring reminders
  isRecurring          Boolean   @default(false) @map("is_recurring")
  recurringPattern     String?   @map("recurring_pattern") // DAILY, WEEKLY, MONTHLY, CUSTOM
  recurringInterval    Int?      @map("recurring_interval") // e.g., every 2 weeks
  recurringEndDate     DateTime? @map("recurring_end_date") // Optional end date
  recurringReminderId  String?   @map("recurring_reminder_id") // Parent recurring reminder

  // Status
  status      String    @default("PENDING") // PENDING, SNOOZED, COMPLETED, DISMISSED
  completedAt DateTime? @map("completed_at")
  dismissedAt DateTime? @map("dismissed_at")

  // Snooze functionality
  snoozedUntil DateTime? @map("snoozed_until")
  snoozeCount  Int       @default(0) @map("snooze_count")

  // Tags and metadata
  tags        String?   // JSON array of tags
  metadata    String?   // JSON string for additional data
  deletedAt   DateTime? @map("deleted_at")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([clientId])
  @@index([remindAt])
  @@index([status])
  @@index([deletedAt])
  @@index([category])
  @@map("reminders")
}

// Calendar sharing for team collaboration
model CalendarShare {
  id              String   @id @default(uuid())
  ownerId         String   @map("owner_id")
  owner           User     @relation("CalendarOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWithId    String   @map("shared_with_id")
  sharedWith      User     @relation("SharedWithUser", fields: [sharedWithId], references: [id], onDelete: Cascade)

  // Visibility levels
  visibilityLevel String   @default("FULL_DETAILS") @map("visibility_level") // BUSY_ONLY, LIMITED_DETAILS, FULL_DETAILS
  permissionLevel String   @default("VIEW_ONLY") @map("permission_level") // VIEW_ONLY, CAN_EDIT, OWNER

  // Share settings
  canEdit         Boolean  @default(false) @map("can_edit")
  color           String?  // Hex color for overlay
  expiresAt       DateTime? @map("expires_at") // Optional expiration for share

  // Shareable link (for public/read-only sharing)
  shareToken      String?  @unique @map("share_token") // For shareable links
  isPublicLink    Boolean  @default(false) @map("is_public_link")

  // Status
  isActive        Boolean  @default(true) @map("is_active")
  deletedAt       DateTime? @map("deleted_at")
  acceptedAt      DateTime? @map("accepted_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([ownerId, sharedWithId])
  @@index([ownerId])
  @@index([sharedWithId])
  @@index([shareToken])
  @@index([isActive])
  @@index([deletedAt])
  @@map("calendar_shares")
}

model EntityVersion {
  id          String    @id @default(uuid())
  entityType  String    @map("entity_type")
  entityId    String    @map("entity_id")
  operation   String
  actorUserId String?   @map("actor_user_id")
  beforeData  String?   @map("before_data")
  afterData   String?   @map("after_data")
  metadata    String?   // JSON string
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([entityType, entityId, createdAt])
  @@index([actorUserId])
  @@map("entity_versions")
}
